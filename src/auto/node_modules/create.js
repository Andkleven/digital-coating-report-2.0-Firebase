const {
  openBrowser,
  goto,
  textBox,
  press,
  write,
  click,
  closeBrowser,
  into,
  waitFor,
  clear,
  focus,
  attach,
  to,
  fileField,
  checkBox,
  below,
  confirm,
  accept
} = require("taiko");

const png = __dirname + "/dummies/dummy.png"
// const jpg = __dirname + "/dummies/dummy.jpg"
// const pdf = __dirname + "/dummies/dummy.pdf"

const login = async () => {
  await openBrowser({ headless: false });
  await goto("http://localhost:3000/");
  await press("Tab");
  await write("lead");
  await press("Tab");
  await write("lead");
  await press("Enter");
};

const select = async (option, label, selector) => {
  await click(label, selector);
  await press("Tab");
  await press("Tab");
  await write(option);
  await press("Enter");
};

const create = async (
  projectName = "Test Project",
  descriptionItems = 5,
  geometries = ["mould", "coatedItem"]
) => {
  const items = descriptionItems * geometries.length;
  const itemIndexes = Array.from(Array(items).keys());

  try {
    // Login
    await login();

    // Create Project
    await waitFor("Create new project");
    await click("Create new project");
    await write(projectName, textBox("Project Name"));
    await write(geometries.length, textBox("Number of Descriptions"));
    await write(items, textBox("Total Number of Items"));
    await click("Submit");

    // Description (Coated Item)
    if (geometries.includes("coatedItem")) {
      await write("Coated Item Description", textBox("Description"));
      await press("Enter");
      await write("Coated Item");
      await press("Enter");
      await write("IFS123", textBox("IFS Activity Codes"));
      await write("CPS123", textBox("CPS"));

      await attach(
        png,
        to(
          fileField(
            { id: "File Upload" },
            {
              selectHiddenElements: true
            }
          )
        )
      );

      await click("Submit");

      // Add items

      let itemIds1 = [];
      for (const index of itemIndexes) {
        if (index < Math.floor(items / geometries.length)) {
          itemIds1.push(`ItemID${index + 1}`);
        }
      }

      await focus(textBox({ id: "custom-undefined-Item ID-undefined" }));

      for (const itemId of itemIds1) {
        await clear();
        await write(itemId);
        await press("Enter");
      }

      confirm('Unsaved changes will be lost, are you sure?', async () => await accept())

      await click("Open all items");

      // Steel Preparation
      await select("Carbon", "Steel");
      await press("Enter");
      await write("Grit");
      await press("Enter");
      await click("Primer 1");
      await press("Enter");
      await write("Carbon");
      await press("Enter");
      await click("Submit");

      // Coating and Visualization
      await write("10", textBox("Ordered Total Rubber Thickness"));
      await press("Enter");
      await write("0");
      await press("Enter");
      await write("5");
      await write("1", textBox("Measurement Points"));
      await select("OD", "TDV (Target Description Value)");
      await write("10", textBox("Measurement Point Actual Steel"));
      await write("A", textBox("Reference Point"));
      // await click("Add Item Rubber Cement");
      // await write("69", textBox("Item Rubber Cement"));
      // Step 1
      await select("Hot Air", "Vulcanization Option");
      await write("1337", textBox("Program Number"));
      await write("2", textBox("Number of Layers"));
      // Layer 1 - Layers need work after adding indexes!
      await select("73165 3mm", "Compound Number");
      await write("5", textBox("Applied Thickness"));
      await write("0", textBox("Shrink"));
      // Layer 2
      await select(
        "73165 3mm",
        "Compound Number",
        below("Cumulative Thickness")
      );
      await write(
        "6",
        textBox("Applied Thickness", below("Cumulative Thickness"))
      );
      await write("5", textBox("Shrink", below("Cumulative Thickness")));
      await click("Submit");

      // Final Inspection
      await write("123", textBox("Hardness of Outer Layer"));
      await write("1", textBox("Number of Hardness of Outer Layer"));
      await write("123", textBox("Identification Marking"));
      await write("123", textBox("Peel Test"));
      await write("1", textBox("Number of Peel Test"));
      await checkBox("Total Coating Thickness").check();
      await checkBox("Spark Test").check();
      await click("Advanced Final Dimensions Check");
      await write("Ref B", textBox("Final Dimensions Reference"));
      await press("Enter");
      await write("10");
      await press("Enter");
      await write("11");
      await click("Submit");
      await click("Back");
    }

    if (geometries.includes("mould") && geometries.includes("coatedItem")) {
      await click("Next");
    }

    // Description (Mould)
    if (geometries.includes("mould")) {
      await write("Mould Description", into(textBox({ name: "description" })));
      await press("Enter");
      await write("Mould");
      await press("Enter");
      await write("IFS123", into(textBox({ name: "ifsActivityCodes" })));
      await write("CPS123", into(textBox({ name: "CPS" })));

      await attach(
        png,
        to(
          fileField(
            { id: "File Upload" },
            {
              selectHiddenElements: true
            }
          )
        )
      );

      await click("Submit");

      // Add items
      let itemIds2 = [];
      for (const index of itemIndexes) {
        if (index < Math.floor(items / geometries.length)) {
          itemIds2.push(`ItemID${index + 1}`);
        }
      }

      await focus(textBox({ id: "custom-undefined-Item ID-undefined" }));

      for (const itemId of itemIds2) {
        await clear();
        await write(itemId);
        await press("Enter");
      }

      await click("Open all items");

      // Steel Preparation
      await select("Carbon", "Steel");
      await press("Enter");
      await write("Grit");
      await press("Enter");
      await click("Primer 1");
      await press("Enter");
      await write("Carbon");
      await press("Enter");
      await click("Submit");

      // Coating and Visualization
      await write("10", textBox("Ordered Total Rubber Thickness"));
      await press("Enter");
      await write("0");
      await press("Enter");
      await write("5");
      await write("1", textBox("Measurement Points"));
      await select("Hot Air", "Vulcanization Option");
      await write("1337", textBox("Program Number"));
      await write("2", textBox("Number of Layers"));
      // Layer 1 - Layers need work after adding indexes!
      await select("73165 3mm", "Compound Number");
      await write("5", textBox("Applied Thickness"));
      await write("0", textBox("Shrink"));
      // Layer 2
      await select(
        "73165 3mm",
        "Compound Number",
        below("Layer 2")
      );
      await write(
        "6",
        textBox("Applied Thickness", below("Layer 2"))
      );
      await write("5", textBox("Shrink", below("Layer 2")));
      await click("Submit");

      // Final Inspection
      await write("123", textBox("Hardness of Outer Layer"));
      await write("1", textBox("Number of Hardness of Outer Layer"));
      await write("123", textBox("Identification Marking"));
      await write("123", textBox("Peel Test"));
      await write("1", textBox("Number of Peel Test"));
      await checkBox("Total Coating Thickness").check();
      await checkBox("Spark Test").check();
      await click("Advanced Final Dimensions Check");
      await write("Ref B", textBox("Final Dimensions Reference"));
      await press("Enter");
      await write("10");
      await press("Enter");
      await write("11");
      await click("Submit");
      await click("Back");
    }

    await click("Send to Production");
  } catch (error) {
    console.error(error);
  } finally {
    await closeBrowser();
  }
};

exports.login = login;
exports.select = select;
exports.create = create;
